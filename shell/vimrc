" Workaround for https://github.com/vim/vim/issues/3117
if has('python3')
  silent! python3 1
endif
" Plugins {{{
  " Install vim-plug automatically
  if empty(glob('~/.vim/autoload/plug.vim'))
    silent !curl -fLo ~/.vim/autoload/plug.vim --create-dirs
      \ https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
  endif
  call plug#begin()

  " Theme and appearance
  Plug 'ayu-theme/ayu-vim'
  Plug 'vim-airline/vim-airline'

  " File navigation & utilities
  Plug 'ctrlpvim/ctrlp.vim'
  Plug 'scrooloose/nerdtree'
  Plug 'tpope/vim-unimpaired'
  Plug 'tpope/vim-eunuch'

  " Git
  Plug 'tpope/vim-fugitive'
  Plug 'airblade/vim-gitgutter'
  Plug 'tpope/vim-rhubarb'

  " Code editing, formatting and completion
  Plug 'vim-syntastic/syntastic'
  Plug 'Valloric/YouCompleteMe', { 'do': '!./install.py --clang-completer --js-completer' }
  Plug 'tpope/vim-commentary'
  Plug 'tpope/vim-abolish'
  Plug 'prettier/vim-prettier', { 'do': 'yarn install' }
  Plug 'tpope/vim-surround'
  Plug 'jiangmiao/auto-pairs'
  Plug 'terryma/vim-multiple-cursors'

  " Ruby and Rails
  Plug 'vim-ruby/vim-ruby'
  Plug 'tpope/vim-rails'
  Plug 'tpope/vim-bundler'
  Plug 'tpope/vim-endwise'

  " JavaScript, React and Ember
  Plug 'pangloss/vim-javascript'
  Plug 'elzr/vim-json'
  Plug 'styled-components/vim-styled-components'
  Plug 'mxw/vim-jsx'
  Plug 'yalesov/vim-emblem'
  Plug 'digitaltoad/vim-pug'
  call plug#end()
" }}}
" General settings {{{
  set nocompatible                    " Allow Vim-only settings (must be first)
  set backspace=indent,eol,start      " Allow backspace in insert mode
  set ttimeoutlen=10                  " Avoid pausing when leaving insert mode
  set visualbell                      " No sounds
  set laststatus=2                    " Always display a status line
  set cmdheight=2                     " Avoid “Press <ENTER> to continue” prompt
  set autoread                        " Reload files changed outside of Vim
  set history=1000                    " Number of commands to remember
  set undolevels=1000                 " Number of undo levels
  set noshowmode                      " Do not show mode
  set hidden                          " Hide buffers when abandoned
  set mouse=a                         " Enable mouse support
" }}}
" Colors {{{
  set termguicolors                   " Enable true colors support
  let ayucolor="mirage"               " Other options: 'light' or 'dark'
  colorscheme ayu
  syntax enable
" }}}
" UI Layout {{{
  set number                          " Show line numbers
  set showcmd                         " Show command in bottom bar
  set nocursorline                    " Highlight current line
  set wildmenu
  set lazyredraw
  set showmatch                       " Higlight matching parenthesis
  set splitright                      " Open new splits on the right
  set list
  set listchars=tab:▸\ ,trail:·       " Display tabs and trailing spaces
  set scrolloff=5                     " Start scrolling when close to margin
  set textwidth=80
  set colorcolumn=+1
  set fillchars+=vert:┃
" }}}
" Behavior {{{
  " Open :help in a new tab
  cnoreabbrev <expr> help getcmdtype() == ":" && getcmdline() == 'help' ?
    \ 'tab help' : 'help'
" }}}
" Spaces & Tabs {{{
  set tabstop=2                       " Two-space tab
  set expandtab                       " Use spaces for tabs
  set softtabstop=2
  set shiftwidth=2
  set modelines=1
  set autoindent smartindent          " Auto-indent based on previous line
  filetype indent plugin on           " Enable file type detection
" }}}
" Searching {{{
  set ignorecase                      " Ignore case when searching
  set incsearch                       " Search as you type
  set hlsearch                        " Highlight all matches
" }}}
" Folding {{{
  set foldmethod=indent               " Fold based on indent level
  set foldnestmax=10                  " Max 10 depth
  set foldenable                      " Do not fold files by default on open
  nnoremap <space> za
  set foldlevelstart=10               " Start with fold level of 10
" }}}
" Swap files {{{
  set noswapfile
  set nobackup
  set nowb
" }}}
" The Silver Searcher {{{
  if executable('ag')
    " Use ag over grep
    set grepprg=ag\ --nogroup\ --nocolor

    " Use ag in CtrlP for listing files. Lightning fast and respects .gitignore
    let g:ctrlp_user_command='ag %s -l --nocolor -g ""'

    " ag is fast enough that CtrlP doesn't need to cache
    let g:ctrlp_use_caching=0
  endif
" }}}
" Auto commands {{{
  " Trim whitespace when saving
  autocmd BufWritePre * :call TrimWhitespace()

  " Set specific type based on file type
  autocmd FileType gitcommit setlocal textwidth=72
  autocmd FileType gitcommit setlocal spell
" }}}
" Key bindings {{{
  " Grep word under cursor
  nnoremap K :grep! "\b<C-R><C-W>\b"<CR>:cw<CR>

  " Cycle through listed buffers
  nnoremap <Tab> :bnext<CR>
  nnoremap <S-Tab> :bprevious<CR>

  " Vim. Live it.
  nnoremap <up> <nop>
  nnoremap <down> <nop>
  nnoremap <left> <nop>
  nnoremap <right> <nop>
  inoremap <up> <nop>
  inoremap <down> <nop>
  inoremap <left> <nop>
  inoremap <right> <nop>

  " Toggle NERDTree
  map <C-n> :NERDTreeToggle<CR>

  " Easy ESC with jk in insert mode
  inoremap jk <esc>
  snoremap jk <esc>

  " Delete current file
  nnoremap <Leader>d. :call DeleteFileAndCloseBuffer()<CR>
" }}}
" Plugins configuration {{{
  " vim-airline
  let g:airline_powerline_fonts=1
  let g:airline#extensions#tabline#enabled=1

  " netrw
  let g:loaded_netrw=1
  let g:loaded_netrwPlugin=1

  " NERDTree
  let g:NERDTreeHijackNetrw=0

  " Syntastic
  set statusline+=%#warningmsg#
  set statusline+=%{SyntasticStatuslineFlag()}
  set statusline+=%*

  let g:syntastic_always_populate_loc_list=1
  let g:syntastic_auto_loc_list=1
  let g:syntastic_check_on_open=0
  let g:syntastic_check_on_wq=0
  let g:syntastic_aggregate_errors=1

  let g:syntastic_error_symbol="✘"
  let g:syntastic_style_error_symbol="✘"
  let g:syntastic_warning_symbol='▶'
  let g:syntastic_style_warning_symbol='▶'

  let g:syntastic_javascript_checkers=['eslint']
  let g:syntastic_ruby_checkers=['mri', 'rubocop']
  let g:syntastic_sass_checkers=['stylelint']
  let g:syntastic_scss_checkers=['stylelint']

  if executable('./node_modules/eslint/bin/eslint.js')
    let g:syntastic_javascript_eslint_exec='./node_modules/eslint/bin/eslint.js'
  endif

  if executable('./node_modules/stylelint/bin/stylelint.js')
    let g:syntastic_sass_stylelint_exec='./node_modules/stylelint/bin/stylelint.js'
    let g:syntastic_scss_stylelint_exec='./node_modules/stylelint/bin/stylelint.js'
  endif

  " vim-prettier
  let g:prettier#autoformat=0
  autocmd BufWritePre *.js,*.jsx,*.mjs,*.ts,*.tsx,*.css,*.less,*.scss,*.json,
        \*.graphql,.eslintrc,.babelrc,.esformatter,.tern-project,.babelrc,
        \.prettierrc
        \ PrettierAsync
" }}}
" Custom functions {{{
  " Trim trailing whitespace without side-effects
  function! TrimWhitespace()
    let l:save=winsaveview()
    %s/\s\+$//e
    call winrestview(l:save)
  endfunction

  " Delete file and close buffer
  fun! DeleteFileAndCloseBuffer()
    let choice = confirm("Delete file and close buffer?", "&Yes\n&No", 1)
    if choice == 1 | call delete(expand('%:p')) | bdelete! | endif
  endfunction
" }}}
" vim:foldmethod=marker:foldlevel=0
